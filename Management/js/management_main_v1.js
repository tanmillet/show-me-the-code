function uploadPaperPageSwitchedIn(a){var b=$($(".page")[a]);b.children(".notice").fadeIn(600)}function uploadPaperPageSwitchedOut(a){var b=$($(".page")[a]);b.children(".notice").fadeOut(600)}function queryPanelSwitchedIn(){$(".bottomActionBox").animate({bottom:"0px"},500)}function queryPanelSwitchedOut(){$(".bottomActionBox").animate({bottom:"-40px"},500)}function onClickedLeftListItem(){var a,b,c,d,e,f,g,h;curElement.is($(this))||(a=parseInt(curElement.attr("ref")),b=switchOutCallbacks[a],null!=b&&b(a),c=curElement.children("img"),d=c.attr("src"),e=d.lastIndexOf("_act.png"),c.attr("src",d.substring(0,e)+".png"),curElement.removeClass("currentPage"),$(this).addClass("currentPage"),curElement=$(this),c=curElement.children("img"),d=c.attr("src"),-1==d.lastIndexOf("_act.png")&&(f=d.lastIndexOf("."),c.attr("src",d.substr(0,f)+"_act.png")),g=parseInt($(this).attr("ref")),h=switchInCallbacks[g],null!=h&&h(g),$(".listPages").animate({scrollTop:pagesTop[g]},500))}function updatePagesTop(){var b,a=$(".page");for(b=1;b<a.length;++b)pagesTop[b]=pagesTop[b-1]+a[b].scrollHeight}function updateLeftColumnTop(){LeftColumnTop[0]=$('.leftColumn[ref="0"]').height()}function onWindowResized(){if(null!=curElement){updatePagesTop();var a=parseInt(curElement.attr("ref"));a>0&&$(".listPages").animate({scrollTop:pagesTop[a]},200),$(".containerMask").animate({width:"100%",height:"100%"},200)}}function updateProgress(a,b){var c=98*(b/100);a.children(".progress").css("width",c+"%")}function formatFileSize(a){return"number"!=typeof a?"":a>=1048576?(a/1048576).toFixed(2)+" MB":(a/1024).toFixed(2)+" KB"}function initFileUpload(){$(".uploadOK").click(function(){$(".uploadProgressBox").fadeOut(1e3,function(){$(".containerMask").fadeOut(1e3),$(".uploadProgressBox").hide(),$(".uploadResultMessage").hide(),$(".uploadOK").hide()})});var a=function(){return{singleFileUploads:!0,add:function(a,b){var c=new RegExp("^.+\\.xlsx$");c.test(b.files[0].name)?b.files[0].size<262144?($(".containerMask").css("background","rgba(0, 0, 0, 0.65)"),$(".containerMask").fadeIn(1e3,function(){$(".uploadOK").hide(),$(".uploadResultMessage.a:first").html("文件处理可能需要一些时间,请稍等。"),$(".uploadProgressBox").fadeIn(),$(".actionLabel").html("正在上传文件:"),$(".fileLabel").html(b.files[0].name),$(".fileSizeLabel").html(formatFileSize(b.files[0].size)),updateProgress($(".progressBar"),0),b.submit()})):($(".containerMask").css("background","rgba(0, 0, 0, 0.65)"),$(".containerMask").fadeIn(1e3,function(){$(".uploadProgressBox").fadeIn(),$(".actionLabel").html("上传文件失败:"),$(".uploadResultMessage").fadeIn(function(){$(".uploadResultMessage a:first").html("文件太大，请将数据分成数个小文件分别上传。")}),$(".uploadOK").fadeIn()})):($(".containerMask").css("background","rgba(0, 0, 0, 0.65)"),$(".containerMask").fadeIn(1e3,function(){$(".uploadProgressBox").fadeIn(),$(".actionLabel").html("上传文件失败:"),$(".uploadResultMessage").fadeIn(function(){$(".uploadResultMessage a:first").html("文件格式错误，必须为xlsx的Excel文档。")}),$(".uploadOK").fadeIn()}))},done:function(a,b){var c,d;return $(".actionLabel").html("处理文件完成:"),$(".uploadResultMessage").show(),null==b.result||""==b.result?($(".uploadResultMessage a:first").html("处理失败，请尝试重新上传"),void 0):(c=JSON.parse(b.result),d=null,d=$.isPlainObject(c)&&"success"==c.result?"处理成功":"处理失败，请尝试重新上传",$.isPlainObject(c)&&"message"in c&&(d+="，"+c.message),$(".uploadResultMessage a:first").html(d),void 0)},progress:function(a,b){var c=parseInt(100*(b.loaded/b.total),10);updateProgress($(".progressBar"),c),100==c&&$(".actionLabel").html("正在解析文件:")},fail:function(){$(".actionLabel").html("上传文件失败:")},always:function(){$(".uploadOK").fadeIn()}}};$(".paperUploader").fileupload(a("0")),$(".scoreUploader").fileupload(a("1")),$(".commentUploader").fileupload(a("2"))}function onSearch(){isSearching||($('.headTabInner[ref="3"]').click(),gShared_table.loadTable())}function TrueFalseValidator(a,b){this._True=a.toUpperCase(),this._False=b.toUpperCase()}function ScoreValidator(a,b){this.minScore=a,this.maxScore=b}function onNameChanged(){var a=$(this).val(),b=gShared_contestantEdit._currentModifiedEntry,c=b._contestant._name;""==a?(alert("名字不能为空"),$(this).val(c)):a.length>29?(alert("名字太长"),$(this).val(c)):b._modifiedContestant._name=a}function onSchoolChanged(){var a=$(this).val(),b=gShared_contestantEdit._currentModifiedEntry,c=b._contestant._school;""==a?(alert("学校不能为空"),$(this).val(c)):a.length>99?(alert("学校名字太长"),$(this).val(c)):"全省"==a?(alert("学校名不能为全省"),$(this).val(c)):b._modifiedContestant._school=a}function onTrueFalseValueChanged(){var c,d,e,f,a=$(this).val().toUpperCase(),b=$(this).attr("previous").toUpperCase();gShared_trueFalseValidator.isValid(a)?(c=$(this).closest("td"),d=c.closest(".editDetailTable"),e=d.attr("index"),f=gShared_contestantEdit._currentModifiedEntry,f.modifyCorrectAndWrong(e,c.index(),b,a,"F"==a),$(this).attr("previous",a),$(".scoreEdit span:first").html(f._modifiedContestant._score)):$(this).val($(this).attr("previous"))}function onScoreValueChanged(){var c,d,e,a=parseInt($(this).val()),b=new ScoreValidator(parseInt($(this).attr("min")),parseInt($(this).attr("max")));b.isValid(a)?(c=$(this).closest("td"),d=c.closest(".editDetailTable").attr("index"),e=gShared_contestantEdit._currentModifiedEntry,e.modifyPoint(d,c.index(),parseInt($(this).attr("previous")),a),$(this).attr("previous",a),$(".scoreEdit span:first").html(e._modifiedContestant._score)):$(this).val($(this).attr("previous"))}function onInlineRowEdit(){var a=$(this).closest("tr");a.is(".rowSelected")||a.find('input[type="checkbox"]').click(),gShared_contestantEdit.doRowEdit(a)}function onInlineRowDelete(){var a=$(this).closest("tr");gShared_contestantEdit.doRowDelete(a)}function onRowEdit(){var a=$(".dataRows").find(".rowSelected:first");gShared_contestantEdit.doRowEdit(a)}function onRowDelete(){var a=$(".dataRows").find(".rowSelected");gShared_contestantEdit.doRowDelete(a)}function onSubmitRowEdit(){var c,a=parseInt(gShared_contestantEdit._currentEditRow.index()),b=new EditAction(gShared_contestantEdit._currentModifiedEntry,a);gShared_actionManager.addAction(b),gShared_table.updateDataByIndex(a,gShared_contestantEdit._currentModifiedEntry._modifiedContestant),gShared_contestantEdit._currentEditRow=null,gShared_contestantEdit._currentEditContestant=null,gShared_contestantEdit._currentModifiedEntry=null,c=$(".editBox"),c.fadeOut(200,function(){$(".containerMask").fadeOut(300)})}function onCancelRowEdit(){gShared_contestantEdit.doCancelRowEdit()}function onSelectAllRow(){var c,d,a=$(".dataRows").children("tr"),b=0;for(c=0;c<a.length;++c)d=$(a[c]),d.is(".rowSelected")?++b:d.find('input[type="checkbox"]').click();if(0!=b&&b==a.length)for(c=0;c<a.length;++c)$(a[c]).find('input[type="checkbox"]').click()}function onDialogExit(){$(this).closest(".commonDialog").fadeOut(300,function(){$(".containerMask").fadeOut(200)})}function initPanelAction(){var a=$(".panelActions");$(".actionBoxEntry div:first").click(onPopOutActionBox),$(".dialogExit").click(onDialogExit),a.find(".remove").click(onRowDelete),a.find(".edit").click(onRowEdit),a.find(".selectAll").click(onSelectAllRow),$(".submitModifications").click(onSubmitModifications),$(".removeModifications").click(onCancelModifications),$(".actionSelectReverse").click(onSelectReverseAction),$(".actionSelectAll").click(onSelectAllAction)}function EditAction(a,b){this._modifiedEntry=a,this._rowIndex=b}function DeleteAction(a,b){this._modifiedEntry=a,this._$deleteRow=b}function onSubmitModifications(){var a,b,c;if(!hasSubmitted){if(a=$(".actionTableData").children(".rowSelected"),0==a.length)return alert("请选择至少一个修改项"),void 0;b=gShared_actionManager.makeSubmitData(),c="./UpdateScores.php",$.ajax({url:c,type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:b,timeout:12e4,beforeSend:function(){hasSubmitted=!0,$(".actionBox").fadeOut(200,function(){var a=$(".containerMask");a.is(":visible")||a.show(),a.css("background","rgba(0, 0, 0, 0.65)"),spinner.spin(a[0])})},success:function(a){var b,c;if("success"==a.result&&(b=a.set,$.isArray(b)))for(c=0;c<b.length;++c)gShared_actionManager.submitAction(b[c])},complete:function(){var a=$(".containerMask");a.css("background","rgba(0, 0, 0, 0.1)"),$(".actionBox").fadeIn(200,function(){spinner.stop()}),hasSubmitted=!1}})}}function onCancelModifications(){var b,c,d,a=$(".actionTableData").children(".rowSelected");if(0==a.length)alert("请选择至少一个修改项");else for(b=0;b<a.length;++b)c=$(a[b]),d=c.children(".contestantIDCell").html(),gShared_actionManager.removeAction(d)}function onSelectAllAction(){var a,b,c;if($(this).is(":checked"))for(a=$(".actionTableData").children("tr"),b=0;b<a.length;++b)c=$(a[b]),c.is(".rowSelected")||c.find('input[type="checkbox"]').click()}function onSelectReverseAction(){var b,c,a=$(".actionTableData").children("tr");for(b=0;b<a.length;++b)c=$(a[b]),c.find('input[type="checkbox"]').click()}function onSelected(){$(this).is(":checked")?$(this).parents("tr:first").addClass("rowSelected"):$(this).parents("tr:first").removeClass("rowSelected")}var Contestant,QueryTableDataset,NumberedNavigator,spinner,QueryTable,isSearching,PaperTemplateSet,ModifiedEntry,ModificationDataException,Validator,gShared_trueFalseValidator,ContestantEdit,DataCorruptedException,onPopOutActionBox,Action,ActionManager,hasSubmitted,Exporter,curElement=null,switchInCallbacks=[uploadPaperPageSwitchedIn,uploadPaperPageSwitchedIn,uploadPaperPageSwitchedIn,queryPanelSwitchedIn],switchOutCallbacks=[uploadPaperPageSwitchedOut,uploadPaperPageSwitchedOut,uploadPaperPageSwitchedOut,queryPanelSwitchedOut],pagesTop=[0,0,0,0],LeftColumnTop=[0,0],resizeTimeout=null,isHoveredSearchDropdown=!1,gShared_table=null,gShared_contestantEdit=null,gShared_paperTemplateSet=null,gShared_actionManager=null,gShared_exporter=null;$("body").ready(function(){var a,b;curElement=$(".headTabInner :first"),curElement.addClass("currentPage"),a=$(".headTabInner img:first"),b=a.attr("src").lastIndexOf("."),a.attr("src",a.attr("src").substr(0,b)+"_act.png"),$(".headTabInner").click(onClickedLeftListItem),$(".headTabInner").hover(function(){var a,b,c;$(this).is(curElement)||(a=$(this).children("img"),b=a.attr("src"),c=b.lastIndexOf("."),a.attr("src",b.substr(0,c)+"_act.png"))},function(){var a,b,c;$(this).is(curElement)||(a=$(this).children("img"),b=a.attr("src"),c=b.indexOf("_act.png"),a.attr("src",b.substring(0,c)+".png"))}),$(".fileAdd").click(function(){$(this).parent().parent().find("input").click()}),$(".userAction").click(function(){$(".dropDownUserAction").toggle()}),$(window).resize(function(){resizeTimeout&&clearTimeout(resizeTimeout),resizeTimeout=setTimeout(onWindowResized,500)}),$(".search").focus(function(){$(".searchHelperDropDown").fadeIn(200)}),$(".searchHelperDropDown").hover(function(){isHoveredSearchDropdown=!0},function(){$(".search").is(":focus")||$(this).fadeOut(200),isHoveredSearchDropdown=!1}),$(".search").blur(function(){isHoveredSearchDropdown||$(".searchHelperDropDown").fadeOut(200)}),$(".searchSubmit").click(onSearch),$(".sctl").keyup(function(a){13==a.keyCode&&onSearch()}),$(".templateDownload").click(function(){window.open($(this).attr("href"))}),$(".exit").click(function(){window.location.href="./ManagementLogin.php"}),updatePagesTop(),updateLeftColumnTop(),initFileUpload(),initPanelAction(),gShared_table=new QueryTable,gShared_contestantEdit=new ContestantEdit,gShared_paperTemplateSet=new PaperTemplateSet,gShared_actionManager=new ActionManager,gShared_exporter=new Exporter}),Contestant=function(a){this._id=a.applyID,this._name=a.name,this._grade=a.grade,this._school=a.school,this._score=a.score,this._paperID=a.paperID,this._detail=a.detail,Contestant.Clone=function(a){return JSON.parse(JSON.stringify(a))}},QueryTableDataset=function(a,b,c,d){this._dataset=[c],this._createdTables=[c],this._pageNumber=c,this._currentNumber=0,this._loadFromServerAction=a,this._queryURL=b,this.parseData=function(a){var b,c,d,e,f,g,h;if(null!=a&&$.isArray(a)){b=[],c=[],d=$(".dataRows");for(e in a)f=new Contestant(a[e]),g=this.createTableRow(f),h=$(g),null!=g&&(h.appendTo(d),b.push(f),c.push(g));d.find('input[type="checkbox"]').click(onSelected),d.find(".inlineEdit").click(onInlineRowEdit),d.find(".inlineDelete").click(onInlineRowDelete),this._dataset[this._currentNumber]=b,this._createdTables[this._currentNumber]=c}},QueryTableDataset.prototype.askForNextPageData=function(a){var b,c,d,e;return this._currentNumber+a<this._pageNumber&&this._currentNumber+a>=0?(this._currentNumber+=a,b=this._createdTables[this._currentNumber],c=this._dataset[this._currentNumber],d=$(".dataRows"),d.empty(),null!=b?(d.append(b),d.find('input[type="checkbox"]').click(onSelected),d.find(".inlineEdit").click(onInlineRowEdit),d.find(".inlineDelete").click(onInlineRowDelete)):$.isArray(c)?this.parseData(c):(e=this,this._loadFromServerAction(this._queryURL+"&page="+this._currentNumber,function(a){"success"===a.result&&e.parseData(a.data)},null)),!0):!1},QueryTableDataset.prototype.createTableRow=function(a){var b=document.createElement("tr"),c='<td class="dataCell"><input type="checkbox"></td>            <td colspan="2" class="dataCell contestantID">{0}</td>            <td class="dataCell contestantName">{1}</td>            <td class="dataCell contestantGrade">{2}</td>            <td colspan="2" class="dataCell contestantSchool">{3}</td>            <td class="dataCell contestantScore">{4}</td>            <td class="dataCell"><div class="inlineAction inlineEdit">            <img src="img/edit_contestant.png"><a>编辑</a></div>            <div class="inlineAction inlineDelete"><img src="img/remove_contestant.png"><a>移除</a></div></td>';return b.innerHTML=c.replace("{0}",a._id).replace("{1}",a._name).replace("{2}",a._grade).replace("{3}",a._school).replace("{4}",a._score),b},null!=d&&this.parseData(d)},QueryTableDataset.prototype.updateContestantRow=function(a,b){var e,c=this._dataset[this._currentNumber],d=this._createdTables[this._currentNumber];null==c||null==d||a>=c.length||a>=d.length||(e=$(d[a]),c[a]=b,e.find(".contestantID").html(b._id),e.find(".contestantName").html(b._name),e.find(".contestantGrade").html(b._grade),e.find(".contestantSchool").html(b._school),e.find(".contestantScore").html(b._score))},NumberedNavigator=function(){var b,c,a=5;this._currentIndex=0,this._dataset=null,this._isBackButtonShown=!1,this._isForwardButtonShown=!1,b=function(a){1==a?$(".backButton").removeAttr("disabled"):$(".backButton").attr("disabled","disabled")},c=function(a){1==a?$(".forwardButton").removeAttr("disabled"):$(".forwardButton").attr("disabled","disabled")},this.setDataset=function(d){$('.numbered[index="'+this._currentIndex+'"]').removeClass("currentNumbered"),this._currentIndex=0,$('.numbered[index="'+this._currentIndex+'"]').addClass("currentNumbered"),null!=d?(this._dataset=d,this._isBackButtonShown=!1,this._isForwardButtonShown=d._pageNumber<a?!1:!0,this.updateNumeredButtons(),b(this._isBackButtonShown),c(this._isForwardButtonShown)):this.updateNumeredButtons()},this.updateNumeredButtons=function(){var d,e,b=1,c=1;for(null!=this._dataset&&(b=this._dataset._currentNumber-this._dataset._currentNumber%a+1,c=Math.min(this._dataset._pageNumber-b+1,a)),d=0;a>d;++d)c>d?(e=$('.numbered[index="'+d.toString()+'"]'),e.show(),e.children("a").html(b+d)):$('.numbered[index="'+d.toString()+'"]').hide()},this.determineMaxStepButton=function(){this._dataset._currentNumber<=a?(0==this._isForwardButtonShown&&this._dataset._pageNumber>a&&(c(!0),this._isForwardButtonShown=!0),1==this._isBackButtonShown&&(b(!1),this._isBackButtonShown=!1)):(this._dataset._currentNumber<this._dataset._pageNumber-a?0==this._isForwardButtonShown&&(c(!0),this._isForwardButtonShown=!0):1==this._isForwardButtonShown&&(c(!1),this._isForwardButtonShown=!1),0==this._isBackButtonShown&&(b(!1),this._isBackButtonShown=!0))},this.canBack=function(){var b=Math.min(this._dataset._currentNumber,a);return{nextPage:b>this._currentIndex,left:b}},this.canForward=function(){var b=this._dataset._pageNumber-this._dataset._currentNumber-1,c=Math.min(b,a);return{nextPage:c>=a-this._currentIndex,left:c}},this.jumpByOffset=function(b){0!=b&&null!=this._dataset&&b+this._currentIndex>=0&&b<a-this._currentIndex&&this._dataset.askForNextPageData(b)&&(this.determineMaxStepButton(),$('.numbered[index="'+this._currentIndex+'"]').removeClass("currentNumbered"),this._currentIndex=this._currentIndex+b,$('.numbered[index="'+this._currentIndex+'"]').addClass("currentNumbered"))},this.updateCurrentIndex=function(){$('.numbered[index="'+this._currentIndex+'"]').removeClass("currentNumbered"),this._currentIndex=Math.min(this._currentIndex,this._dataset._currentNumber%a),$('.numbered[index="'+this._currentIndex+'"]').addClass("currentNumbered")}},NumberedNavigator.prototype.jumpTo=function(a){if(a!=this._currentIndex&&null!=this._dataset){var b=a-this._currentIndex;this._dataset.askForNextPageData(b)&&(this.determineMaxStepButton(),$('.numbered[index="'+this._currentIndex+'"]').removeClass("currentNumbered"),this._currentIndex=a,$('.numbered[index="'+this._currentIndex+'"]').addClass("currentNumbered"))}},NumberedNavigator.prototype.back=function(){var a,b;null!=this._dataset&&(a=this.canBack(),b=a.left,a.nextPage&&b>0?this._dataset.askForNextPageData(-b)&&(this.determineMaxStepButton(),this.updateNumeredButtons(),this.updateCurrentIndex()):b>0&&this.jumpByOffset(-b))},NumberedNavigator.prototype.forward=function(){if(null!=this._dataset){var a=this.canForward();a.nextPage&&a.left>0?this._dataset.askForNextPageData(a.left)&&(this.determineMaxStepButton(),this.updateNumeredButtons(),this.updateCurrentIndex()):a.left>0&&this.jumpByOffset(a.left)}},spinner=new Spinner({className:"spinner",lines:8,length:18,width:10,color:"#fff"}),QueryTable=function(){var a,b,c,d,e,f;this._numberedNavigator=new NumberedNavigator,this._tableDataset=null,a=this,b=function(){$(".numbered").click(function(){a._numberedNavigator.jumpTo(parseInt($(this).attr("index")))}),$(".backButton").click(function(){a._numberedNavigator.back()}),$(".forwardButton").click(function(){a._numberedNavigator.forward()}),$(".numbered").hide(),$(".numbered :first").show(),$(".numbered :first").addClass("currentNumbered"),$(".backButton").attr("disabled","disabled"),$(".forwardButton").attr("disabled","disabled")},b(),c=function(){var c,d,e,f,g,h,a=$(".helperRow"),b="";for(c=0;c<a.length;++c)if(d=$(a[c]),e=d.children("input"),e.length>0&&$(e[0]).val().length>0)if(f=$(e[0]),g=d.attr("param"),1==e.length&&f.is(".textInput"))b.length>0&&(b+="&"),b+=g+"="+f.val();else{if(2!=e.length||!f.is(".numberInput"))continue;h=$(e[1]),h.is(".numberInput")&&(b.length>0&&(b+="&"),b+=g+"="+f.val()+","+h.val())}return b},d=function(){var a=$(".dataRows");a.empty()},a=this,e=null,f=function(b,c){var e,d=b;"success"===d.result&&($(".sctl").val(""),gShared_actionManager.clear(),e=d.pageNumber,a._tableDataset=new QueryTableDataset(QueryTable.ajaxQuery,c.requestURL,e,d.data),a._numberedNavigator.setDataset(a._tableDataset))},this.loadTable=function(){var a,b,g;d(),a="QueryContestants.php?",b=c(),0==b.length?(g=$(".search").val(),g.length>0&&(a+="keyword="+g+"&r="+(~~(1e5*Math.random())).toString(16),e=a,a=encodeURI(a),QueryTable.ajaxQuery(a,f,null))):(a+=b+"&r="+(~~(1e5*Math.random())).toString(16),e=a,a=encodeURI(a),QueryTable.ajaxQuery(a,f,null))}},QueryTable.ajaxQuery=function(a,b){$.ajax({type:"GET",url:a,contentType:"application/json; charset=utf-8",dataType:"json",timeout:12e4,beforeSend:function(b){b.requestURL=a,$(".contestantsTable").fadeOut(500,function(){this.style.width="100%"}),$(".numberedNavigator").fadeOut(500),$(".bottomActionBox").fadeOut(200),$(".containerMask").fadeIn(1e3,function(){spinner.spin($(".containerMask")[0])})},success:function(a,c,d){b(a,d)},complete:function(){$(".containerMask").fadeOut(400,function(){$(".contestantsTable").fadeIn(500,function(){this.style.width="98%"}),$(".numberedNavigator").fadeIn(500),$(".bottomActionBox").fadeIn(200),spinner.stop()})}})},QueryTable.prototype.getDataByRowIndex=function(a){var c,b=null;return null!=this._tableDataset&&(c=this._tableDataset._dataset[this._tableDataset._currentNumber],null!=c&&c.length>=a&&(b=c[a])),b},QueryTable.prototype.updateDataByIndex=function(a,b){null!=this._tableDataset&&this._tableDataset.updateContestantRow(a,b)},QueryTable.prototype.appendExistedRow=function(a,b){if(null!=a&&null!=b){var c=$(".dataRows");c.length>0&&(a.appendTo(c),this._tableDataset._createdTables[this._tableDataset._currentNumber].push(a[0]),this._tableDataset._dataset[this._tableDataset._currentNumber].push(b),a.find('input[type="checkbox"]').click(onSelected),a.find(".inlineEdit").click(onInlineRowEdit),a.find(".inlineDelete").click(onInlineRowDelete),a.find(".contestantID").html(b._id),a.find(".contestantName").html(b._name),a.find(".contestantGrade").html(b._grade),a.find(".contestantSchool").html(b._school),a.find(".contestantScore").html(b._score))}},QueryTable.prototype.deleteRowByIndex=function(a){var b,c;null!=this._tableDataset&&(b=this._tableDataset._dataset[this._tableDataset._currentNumber],c=this._tableDataset._createdTables[this._tableDataset._currentNumber],null!=b&&null!=c&&b.length>=a&&(b.splice(a,1),c.splice(a,1)))},isSearching=!1,PaperTemplateSet=function(){this._paperTemplates={}},PaperTemplateSet.loadPaperTemplate=function(a){var c,b=null;return null!=a&&(c="QueryPaper.php?pid="+a.toString(),$.ajax({type:"GET",url:c,async:!1,timeout:6e4,contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){var c,d,e,f,g,h,i;if("success"==a.result)for(b=a.data,c=b.quesTemplate,d=c.index,e=0;e<d.length;++e)f=c[d[e]],g=f.labels.split(","),h=-1!=g[1].indexOf("分值"),f.type=h?"Score":"TrueOrFalse",h||(i=~~(f.score/f.count),f.point=i)}})),b},PaperTemplateSet.prototype.getPaperTemplateByID=function(a){if(a in this._paperTemplates)return this._paperTemplates[a];var b=PaperTemplateSet.loadPaperTemplate(a);return null!=b&&(this._paperTemplates[a]=b),b},ModifiedEntry=function(a){this._modifiedContestant=Contestant.Clone(a),this._contestant=a,this._paper=PaperTemplateSet.loadPaperTemplate(a._paperID),this._quesTemplate=this._paper.quesTemplate,this._quesTypeModified={}},ModificationDataException=function(){return{message:"修改成绩数据出错，请取消该修改项，重新再试。",level:"Critical"}},ModifiedEntry.prototype.modifyCorrectAndWrong=function(a,b,c,d,e){var f,g,h;if(c!==d)if(a in this._quesTypeModified||(this._quesTypeModified[a]={}),f=this._quesTypeModified[a],g=e?-this._quesTemplate[a].point:this._quesTemplate[a].point,this._modifiedContestant._score+=g,b in f){if(f[b].isTurnToWrong==e)throw new ModificationDataException;h=f[b].offset+g,0==h?delete f[b]:(f[b].from=c,f[b].to=d,f[b].isTurnToWrong=e,f[b].offset=h)}else f[b]={offset:g,from:c,to:d,isPointModified:!1,isTurnToWrong:e}},ModifiedEntry.prototype.modifyPoint=function(a,b,c,d){var e,f,g;if(c!==d){if(a in this._quesTypeModified||(this._quesTypeModified[a]={}),e=this._quesTypeModified[a],f=d-c,b in e){if(g=e[b],c!=g.to)throw new ModificationDataException;d==g.from?delete e[b]:(e[b].to=d,e[b].isTurnToWrong=0==d?!0:!1,e[b].offset+=f)}else e[b]={offset:f,from:c,to:d,isPointModified:!0,isTurnToWrong:0==d?!0:!1};this._modifiedContestant._score+=f}},ModifiedEntry.prototype.updateContestant=function(){var a,b,c,d,e,f,g,h,i;if(null!=this._quesTypeModified&&null!=this._paper&&0!=this._quesTypeModified.length)for(a in this._quesTypeModified){b=this._quesTemplate[a].domains.split(","),c=this._modifiedContestant._detail,d=c[a].print,e=this._quesTypeModified[a];for(f in e)g=e[f],h=b[parseInt(f)],d[f]=g.to.toString(),c[a].score+=g.offset,i=c[h],g.isPointModified?0!=g.from||g.isTurnToWrong?0==g.to&&g.isTurnToWrong&&(i.count--,i.print--):(i.count++,i.print++):g.isTurnToWrong?(i.count--,i.print--):(i.count++,i.print++),c[a].print=d}},Validator=function(){Validator.prototype.isValid=function(){}},TrueFalseValidator.prototype=new Validator,TrueFalseValidator.prototype.constructor=TrueFalseValidator,TrueFalseValidator.prototype.isValid=function(a){return a.toUpperCase()==this._True||a.toUpperCase()==this._False},ScoreValidator.prototype=new Validator,ScoreValidator.prototype.constructor=ScoreValidator,ScoreValidator.prototype.isValid=function(a){return a>=this.minScore&&a<=this.maxScore},gShared_trueFalseValidator=new TrueFalseValidator("T","F"),ContestantEdit=function(){this._scoreEditCache={},this._currentEditRow=null,this._currentEditContestant=null,this._currentModifiedEntry=null;var a=function(){$(".editOK").click(onSubmitRowEdit),$(".editCancel").click(onCancelRowEdit),$(".nameEdit input").change(onNameChanged),$(".schoolEdit input").change(onSchoolChanged)};a(),this.popEditBox=function(a){var b,c,d;if(1!=a.length)return!1;if(b=gShared_table.getDataByRowIndex(parseInt(a.index())),null!=b&&null!=b._paperID){if(c=null,b._paperID in this._scoreEditCache)return c=this._scoreEditCache[b._paperID],d=gShared_paperTemplateSet.getPaperTemplateByID(b._paperID),this.fillAllData(a,b,c),this.fillDataWith(d,c,b),!0;if(d=gShared_paperTemplateSet.getPaperTemplateByID(b._paperID),null!=d){try{c=ContestantEdit.generateScoreEditTable(d,b)}catch(e){"Fatal"==e.level?alert(e.message):c=null}null!=c&&(this._scoreEditCache[b._paperID]=c)}if(null!=c)return this.fillAllData(a,b,c),!0}return!1},this.fillAllData=function(a,b,c){var e,f,d=$(".editBox");d.find(".nameEdit input:first").val(b._name),d.find(".schoolEdit input:first").val(b._school),d.find(".scoreEdit span:first").html(b._score),e=$(".editScoreWrapper"),e.find(".editDetailTableWrapper").remove(),this._currentEditRow=a,this._currentEditContestant=b,f=gShared_actionManager.getAction(b._id),this._currentModifiedEntry=null!=f?f._modifiedEntry:new ModifiedEntry(b),$(c).appendTo(e),$(".trueOrFalseInput").change(onTrueFalseValueChanged),$(".scoreInput").change(onScoreValueChanged)},this.fillDataWith=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(null!=a&&null!=b&&null!=c&&null!=this._currentModifiedEntry)for(d=a.quesTemplate,e=d.index,f=c._detail,g=this._currentModifiedEntry._quesTypeModified,h=0;h<e.length;++h)if(i=e[h],j=d[i],k=i in g?g[i]:null,l=f[i],m=ContestantEdit.getRange(j),n=m.start,m=m.end-n,o=l.print,p=$('.editDetailTable[index="'+i+'"]'),0!=p.length)if(q=p.attr("datatype"),r=p.find(".editInputRow"),null==k){if("TrueOrFalse"==q)for(s=0;s<r.length;++s)for(t=$(r[s]),u=t.find("input"),v=0;m>v;++v)w=o[v],$(u[v]).attr("previous",w),$(u[v]).val(w);else if("Score"==q)for(s=0;s<r.length;++s)for(t=$(r[s]),u=t.find("input"),v=0;m>v;++v)w=o[v],$(u[v]).attr("previous",w),$(u[v]).val(w)}else if("TrueOrFalse"==q)for(s=0;s<r.length;++s)for(t=$(r[s]),u=t.find("input"),v=0;m>v;++v)w=o[v],v in k&&(w=k[v].to),$(u[v]).attr("previous",w),$(u[v]).val(w);else if("Score"==q)for(s=0;s<r.length;++s)for(t=$(r[s]),u=t.find("input"),v=0;m>v;++v)w=o[v],v in k&&(w=k[v].to),$(u[v]).attr("previous",w),$(u[v]).val(w)}},DataCorruptedException=function(){return{message:"修改成绩数据出错，请取消该修改项，重新再试。",level:"Fatal"}},ContestantEdit.getRange=function(a){var b=a.range.split("-"),c=1,d=0;return 2==b.length&&(c=parseInt(b[0]),d=parseInt(b[1])+1),(isNaN(c)||isNaN(d)||c>=d)&&(c=1,d=parseInt(a.count)+1),{start:c,end:d}},ContestantEdit.generateScoreEditTable=function(a,b){var g,h,i,j,k,l,m,n,o,p,q,r,s,c=a.quesTemplate,d=c.index,e=$("<div class='editDetailTableWrapper'></div>"),f=b._detail;for(g=0;g<d.length;++g){if(h=d[g],i=c[h],j=i.type,k=f[h],l=$("<table class='editDetailTable' datatype='"+j+"' + index='"+h+"'></table>"),m="<tr><th style='padding-right: 10px; padding-top: 10px' rowspan='2'>"+h+"</th>",n=k.print,o="<tr class='editInputRow'>",p=ContestantEdit.getRange(i),q=p.start,p=p.end-q,"TrueOrFalse"==j)for(r=0;p>r;++r)m+="<th>"+(q+r)+"</th>",o+="<td><input class='trueOrFalseInput' type='text' value='"+n[r]+"' previous='"+n[r]+"'></td>";else{if("Score"!=j)throw new DataCorruptedException;if(s=i.values.split(","),s.length!=p)throw new DataCorruptedException;for(r=0;p>r;++r)m+="<th>"+(q+r)+"</th>",o+="<td><input class='scoreInput' type='text' value='"+n[r]+"' min='0' max='"+s[r]+"' previous='"+n[r]+"'></td>"}$(m).appendTo(l),$(o).appendTo(l),$(l).appendTo(e)}return e},ContestantEdit.prototype.doRowEdit=function(a){0!=this.popEditBox(a)?($(".actionBox").hide(),$(".containerMask").css("background","rgba(0,0,0,0.1)"),$(".containerMask").fadeIn(300,function(){var a=$(".editBox");a.css("margin-top",-($(".editBox").height()/2)),a.fadeIn(200)})):alert("数据损坏，请点击删除，提交后用Excel重新添加该考生数据")},ContestantEdit.prototype.doCancelRowEdit=function(){this._currentEditRow=null,this._currentEditContestant=null,this._currentModifiedEntry=null;var a=$(".editBox");a.fadeOut(200,function(){$(".containerMask").fadeOut(300)})},ContestantEdit.prototype.doRowDelete=function(a){var b,c,d,e;if(0!=a.length)for(b=0;b<a.length;++b)c=$(a[b]),d=gShared_table.getDataByRowIndex(parseInt(c.index())),e=new DeleteAction(new ModifiedEntry(d),c),gShared_actionManager.addAction(e),gShared_table.deleteRowByIndex(parseInt(c.index())),c.remove()},onPopOutActionBox=function(){$(".containerMask").css("background","rgba(0,0,0,0.1)"),$(".editBox").hide(),$(".containerMask").fadeIn(300,function(){$(".actionBox").fadeIn(200)})},Action=function(){},Action.prototype.toTableRow=function(){},Action.prototype.undo=function(){},EditAction.prototype=new Action,EditAction.prototype.constructor=EditAction,EditAction.prototype.generateModifier=function(){var e,f,g,h,i,a=this._modifiedEntry._contestant,b=this._modifiedEntry._modifiedContestant,c=this._modifiedEntry._quesTypeModified,d="";for(e in c){f=c[e];for(g in f)h=f[g],i=parseInt(g)+1,d+=e+"题号："+i+"，值由"+h.from+"改至"+h.to+"<br>"}return a._name!=b._name&&(d+="姓名被修改<br>"),a._school!=b._school&&(d+="学校名称被修改<br>"),d},EditAction.prototype.updateTableRow=function(a,b){var c=this._modifiedEntry._modifiedContestant;b.children(".contestantIDCell").html(c._id),b.children(".actionTypeCell").html("修改"),b.children(".actionDetailCell").html(a)},EditAction.prototype.undo=function(){gShared_table.updateDataByIndex(this._rowIndex,this._modifiedEntry._contestant)},DeleteAction.prototype=new Action,DeleteAction.prototype.constructor=DeleteAction,DeleteAction.prototype.updateTableRow=function(a,b){var c=this._modifiedEntry._modifiedContestant;b.children(".contestantIDCell").html(c._id),b.children(".actionTypeCell").html("删除"),b.children(".actionDetailCell").html(a)},DeleteAction.prototype.undo=function(){null!=this._modifiedEntry&&null!=this._$deleteRow&&gShared_table.appendExistedRow(this._$deleteRow,this._modifiedEntry._contestant)},ActionManager=function(){this._actions={},this.createTableRow=function(){return $("<tr><td><input type='checkbox'></td><td class='contestantIDCell'></td><td class='actionTypeCell'></td><td class='actionDetailCell'></td></tr>")}},ActionManager.prototype.clear=function(){this._actions={},$(".actionTableData").empty(),$(".actionSelectAll").prop("checked",!1)},ActionManager.prototype.getAction=function(a){return a in this._actions?this._actions[a].actionInstance:null},ActionManager.prototype.makeSubmitData=function(){var b,c,d,e,f,a=[];for(b in this._actions)if(c=this._actions[b].actionInstance,null!=c){if(d=c._modifiedEntry,e={},f=d._modifiedContestant,c instanceof EditAction)e.action="update",d.updateContestant(),e.applyID=f._id,e.name=f._name,e.school=f._school,e.detail=f._detail,e.score=f._score,e.paperID=f._paperID;else{if(!(c instanceof DeleteAction))continue;e.action="delete",e.applyID=f._id,e.paperID=f._paperID}a.push(e)}return JSON.stringify(a)},ActionManager.prototype.addAction=function(a){var b,c,d,e;null!=a&&(b=a._modifiedEntry._modifiedContestant._id,c=a instanceof EditAction,d=c?a.generateModifier():"删除",b in this._actions?""==d?this.removeAction(b):(a.updateTableRow(d,this._actions[b].boundRow),this._actions[b].actionInstance=a):""!=d&&(e=this.createTableRow(),a.updateTableRow(d,e),this._actions[b]={actionInstance:a,boundRow:e},e.appendTo($(".actionTableData")),e.find('input[type="checkbox"]').click(onSelected)))},ActionManager.prototype.removeAction=function(a){var b,c;a in this._actions&&(b=this._actions[a],null!=b&&(c=b.actionInstance,c.undo(),b.boundRow.remove(),delete this._actions[a]))
},ActionManager.prototype.submitAction=function(a){if(a in this._actions){var b=this._actions[a];null!=b&&(b.actionInstance,b.boundRow.remove(),delete this._actions[a])}},hasSubmitted=!1,Exporter=function(){this._years=null,this._grades=null;var a=function(){$(".export").click(Exporter.ShowExportDialog),$(".yearSelect").change(Exporter.SelectYearChanged),$(".exportOK").click(Exporter.DoExport),$(".exportCancel").click(Exporter.CloseDialog)};a()},Exporter.ClearSelector=function(a){a.find("option").remove()},Exporter.DoExport=function(){var c,a=$(".gradeSelect").val(),b=$(".yearSelect").val();return null==a||""==a||null==b||""==b?($(".exportResult").html("非法的年级或是年份参数,请尝试重新打开对话框"),void 0):(c="./ExportScores.php?grade="+a+"&year="+b,$.ajax({type:"GET",url:c,contentType:"application/json; charset=utf-8",dataType:"json",timeout:3e5,beforeSend:function(){$(".exportBox").fadeOut(500,function(){spinner.spin($(".containerMask")[0])})},success:function(a){if("success"==a.result)$(".containerMask").fadeOut(1e3,function(){spinner.stop(),window.location.href="./DownloadExcel.php?fid="+a.fid});else{var b="错误, 请重新尝试";"message"in a&&(b=a.message),$(".exportBox").fadeIn(500,function(){spinner.stop(),$(".exportResult").html(b)})}},error:function(a,b){"timeout"===b?$(".exportBox").fadeIn(500,function(){$(".exportResult").html("已超时, 请尝试重新导出"),spinner.stop()}):$(".exportBox").fadeIn(500,function(){$(".exportResult").html("错误, 请重新尝试"),spinner.stop()})}}),void 0)},Exporter.UpdateYearSelector=function(a){var c,d,b=$(".yearSelect");Exporter.ClearSelector(b),c="";for(d in a)c+="<option>"+a[d]+"</option>";0!=c.length&&$(c).appendTo(b)},Exporter.UpdateGradeSelector=function(a){var c,d,b=$(".gradeSelect");Exporter.ClearSelector(b),c="";for(d in a)c+="<option>"+a[d]+"</option>";a.length>0&&(c+="<option>全部年级</option>"),0!=c.length&&$(c).appendTo(b)},Exporter.prototype.queryGrade=function(a){var b,c;if(null!=a||$.inArray(a,this._years)){if(null==this._grades&&(this._grades=[]),a in this._grades)return Exporter.UpdateGradeSelector(this._grades[a]),void 0;b="./QueryGrade.php?year="+a,c=this,$.ajax({type:"GET",url:b,contentType:"application/json; charset=utf-8",dataType:"json",timeout:3e3,beforeSend:function(){Exporter.ClearSelector($(".gradeSelect"))},success:function(b){if("success"==b.result){var d=b.grades;Exporter.UpdateGradeSelector(d),c._grades[a]=d}}})}},Exporter.prototype.queryYear=function(){var a="./QueryYear.php",b=this;$.ajax({type:"GET",url:a,contentType:"application/json; charset=utf-8",dataType:"json",timeout:3e3,beforeSend:function(){Exporter.ClearSelector($(".yearSelect")),Exporter.ClearSelector($(".gradeSelect"))},success:function(a){var c,d;"success"==a.result&&(c=a.years,Exporter.UpdateYearSelector(c),b._years=c,c.length>0&&(d=c[0],b.queryGrade(d)))}})},Exporter.ShowExportDialog=function(){var a=$(".containerMask");a.css("background","rgba(0, 0, 0, 0.1)"),a.fadeIn(500,function(){$(".exportBox").fadeIn()}),gShared_exporter.queryYear()},Exporter.SelectYearChanged=function(){var a=$(this).val();gShared_exporter.queryGrade(a)},Exporter.CloseDialog=function(){Exporter.ClearSelector($(".yearSelect")),Exporter.ClearSelector($(".gradeSelect")),gShared_exporter._years=null,gShared_exporter._grades=null,$(".exportResult").html(""),$(".exportBox").fadeOut(),$(".containerMask").fadeOut(1e3)};